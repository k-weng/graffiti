{"metadata":{"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}},"usedHelpers":[]},"ignored":false,"code":"Template.messageList.onCreated(function () {\n  var self = this;\n  Session.set('loaded', false);\n  self.autorun(function () {\n    Meteor.subscribe('messages', Router.current().params._id, function () {\n      console.log(\"params id \" + Router.current().params._id);\n      Session.set('loaded', true);\n      console.log(\"subscribe 2\");\n    });\n  });\n});\n\nTemplate.messageList.helpers({\n  messages: function () {\n    return Messages.find();\n  }\n});\n\nTemplate.messageList.events({\n  'click .textClass': function (e, template) {\n    console.log($(e.currentTarget).data(\"id\"));\n    Meteor.call(\"messageVote\", $(e.currentTarget).data(\"id\"));\n    // alert('id: ' + $(e.currentTarget).(\"votes\"));\n  }\n});\n\nTemplate.messageList.onRendered(function () {\n  var graph,\n      color = d3.scale.category10();\n  var maxLife = 5 * 60 * 1000;\n  graph = new myGraph(\"#vis\");\n  Messages.find().observe({\n    added: function (doc) {\n      graph.addNode(doc);\n    },\n    removed: function (doc) {\n      graph.removeNode(doc);\n    },\n    changed: function (updated, old) {\n      graph.updateNode(updated, old);\n    }\n  });\n\n  function myGraph(el) {\n\n    this.updateNode = function (updated, old) {\n      console.log(\"updateNode\");\n      console.log(old._id);\n      var n = findNode(old._id);\n      // // debugger\n      n.votes = updated.votes;\n      n.life = updated.life;\n      // nodes.splice(findNodeIndex(n),1);\n      // nodes.push(n);\n      //     debugger\n      //     var node = vis.selectAll(\"g.node\")\n      //      .data(nodes, function(d) { return d._id; })\n      //      .attr(\"id\",function(d){return \"node-\"+ d._id});\n      // // debugger\n      //     node.transition().duration(100);\n      //     node.style(\"opacity\",1);\n      // debugger\n      d3.select(\"#node-\" + old._id).transition().duration(10).style(\"opacity\", function (d) {\n        console.log(d.text + \" \" + d.life);return d.life / maxLife;\n      }).transition().duration(function (d) {\n        console.log(\"clicked\");return d.life;\n      }).style(\"opacity\", 1).each('end', function (d) {\n        removeNode(d);\n      });\n    };\n\n    this.addNode = function (doc) {\n      nodes.push(doc);\n      update();\n    };\n\n    this.removeNode = function (doc) {\n      var i = 0;\n      var n = findNode(doc._id);\n      nodes.splice(findNodeIndex(doc), 1);\n      update();\n    };\n\n    var removeNode = function (doc) {\n      var i = 0;\n      var n = findNode(doc._id);\n      nodes.splice(findNodeIndex(doc), 1);\n      update();\n    };\n\n    var findNode = function (id) {\n      for (var i in babelHelpers.sanitizeForInObject(nodes)) {\n        if (nodes[i]._id === id) return nodes[i];\n      };\n    };\n\n    var findNodeIndex = function (doc) {\n      for (var i = 0; i < nodes.length; i++) {\n        if (nodes[i].id == doc._id) {\n          return i;\n        }\n      };\n    };\n\n    var w = 500,\n        h = 500;\n    var svg = d3.select(el).append(\"svg:svg\").attr(\"width\", w).attr(\"height\", h).attr(\"id\", \"svg\").attr(\"pointer-events\", \"all\").attr(\"viewBox\", \"0 0 \" + w + \" \" + h).attr(\"perserveAspectRatio\", \"xMinYMid\");\n\n    var vis = svg.append('svg:g');\n\n    var force = d3.layout.force();\n\n    var nodes = force.nodes();\n\n    var label = d3.select(\"#bubble-labels\");\n\n    var update = function () {\n\n      var node = vis.selectAll(\"g.node\").data(nodes, function (d) {\n        return d._id;\n      });\n\n      var nodeEnter = node.enter().append(\"g\").attr(\"class\", \"node\").call(force.drag);\n\n      nodeEnter.append(\"svg:circle\").attr(\"r\", function (d) {\n        return d.radius;\n      }).attr(\"id\", function (d) {\n        return \"Node;\" + d.id;\n      }).attr(\"class\", \"nodeStrokeClass\").style(\"fill\", function (d, i) {\n        return \"red\";\n      }).style(\"opacity\", 1).attr(\"id\", function (d) {\n        console.log(d.text + \" \" + d._id + \" add id\");\n        return \"circle-\" + d._id;\n      });\n\n      //the native solution\n      nodeEnter.append(\"svg:text\").attr(\"class\", \"textClass\").style(\"fill\", function (d, i) {\n        return color(i % 3);\n      }).text(function (d) {\n        return d.text;\n      }).style(\"opacity\", function (d) {\n        console.log(d.text + \" \" + d.life);return d.life / maxLife;\n      }).transition().duration(function (d) {\n        return d.life;\n      }).style(\"opacity\", 0).each('end', function (d) {\n        removeNode(d);\n      }).attr(\"data-id\", function (d) {\n        return d._id;\n      }).attr(\"id\", function (d) {\n        console.log(d.text + \" \" + d._id + \" add id\");\n        return \"node-\" + d._id;\n      });\n\n      // for(var i = 0; i<nodes.length; i++){\n      //   console.log(nodes[i]._id + \" nodes\");\n      //   d3plus.textwrap()\n      //     .container(d3.select(\"#circle-\"+nodes[i]._id))\n      //     .resize(true)\n      //     .draw();\n      // }\n\n      // the foreign solution\n      nodeEnter.append(\"foreignObject\").attr(\"width\", 480).attr(\"height\", 500).attr(\"x\", function (d) {\n        return d.x;\n      }).append(\"xhtml:body\").style(\"font\", \"14px 'Helvetica Neue'\").html(\"<p> a <p>\");\n\n      //foreign object solution\n      // nodeEnter.append(\"foreignObject\")\n      //   .attr(\"class\",\"textClass2\")\n      //   .attr('x', -150/2)\n      //   .attr('y', -20)\n      //   .attr(\"width\", 150)\n      //   .attr(\"height\", 200)\n      //   .append(\"xhtml:p\")\n      //   .attr('style','word-wrap: break-word; text-align:center;')\n      //   .style(\"color\",function(d,i){return color(i%3);})\n      //   .html(function(d){return d.text})\n      //   .transition()\n      //   .duration(500)\n      //   .style(\"opacity\",0);\n\n      node.exit().remove();\n\n      force.on(\"tick\", function () {\n        var q = d3.geom.quadtree(nodes),\n            i = 0,\n            n = nodes.length;\n\n        while (++i < n) q.visit(collide(nodes[i]));\n        node.attr(\"transform\", function (d) {\n          return \"translate(\" + d.x + \",\" + d.y + \")\";\n        });\n\n        d3.select(\"#bubble-labels\").selectAll(\".bubble-label\").style(\"left\", function (d) {\n          return d.x - d.radius / 2 + \"px\";\n        }).style(\"top\", function (d) {\n          return d.y + 120 - d.radius / 2 + \"px\";\n        });\n      });\n\n      function collide(node) {\n        // console.log(\"collide\");\n        var r = node.radius + 16,\n            nx1 = node.x - r,\n            nx2 = node.x + r,\n            ny1 = node.y - r,\n            ny2 = node.y + r;\n        return function (quad, x1, y1, x2, y2) {\n          if (quad.point && quad.point !== node) {\n            var x = node.x - quad.point.x,\n                y = node.y - quad.point.y,\n                l = Math.sqrt(x * x + y * y),\n                r = node.radius + quad.point.radius;\n            if (l < r) {\n              l = (l - r) / l * .5;\n              node.x -= x *= l;\n              node.y -= y *= l;\n              quad.point.x += x;\n              quad.point.y += y;\n            }\n          }\n          return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;\n        };\n      }\n\n      force.gravity(.05).size([w, h]).start();\n    };\n\n    update();\n  }\n});","ast":null,"map":{"version":3,"sources":["/client/templates/messages/message_list.js"],"names":[],"mappings":"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","file":"/client/templates/messages/message_list.js.map","sourcesContent":["Template.messageList.onCreated(function(){\n\tvar self = this;\n  Session.set('loaded',false);\n\tself.autorun(function(){\n\t\tMeteor.subscribe('messages', Router.current().params._id, function(){\n      console.log(\"params id \"+Router.current().params._id);\n      Session.set('loaded',true);\n      console.log(\"subscribe 2\");\n    });\n\t});\n});\n\n\nTemplate.messageList.helpers({\n\tmessages: function(){\n\t\treturn Messages.find();\n\t}\n});\n\nTemplate.messageList.events({\n\t'click .textClass':function(e, template){\n    console.log($(e.currentTarget).data(\"id\"));\n    Meteor.call(\"messageVote\",$(e.currentTarget).data(\"id\"));\n    // alert('id: ' + $(e.currentTarget).(\"votes\"));\n\t}\n});\n\nTemplate.messageList.onRendered(function(){\nvar graph,\n    color = d3.scale.category10();\nvar maxLife = (5)*(60)*(1000);\ngraph = new myGraph(\"#vis\");\nMessages.find().observe({\n  added: function (doc) {\n    graph.addNode(doc);\n  },\n  removed: function (doc) {\n    graph.removeNode(doc);\n  },\n  changed: function(updated, old){\n    graph.updateNode(updated,old);\n  }\n});\n\nfunction myGraph(el){\n\n  this.updateNode = function(updated, old){\n    console.log(\"updateNode\"); \n    console.log(old._id);\n    var n = findNode(old._id);\n    // // debugger\n    n.votes = updated.votes;\n    n.life = updated.life;\n    // nodes.splice(findNodeIndex(n),1);\n    // nodes.push(n);\n//     debugger\n//     var node = vis.selectAll(\"g.node\")\n//      .data(nodes, function(d) { return d._id; })\n//      .attr(\"id\",function(d){return \"node-\"+ d._id});\n// // debugger\n//     node.transition().duration(100);\n//     node.style(\"opacity\",1);\n// debugger\n    d3.select(\"#node-\"+old._id)\n    .transition()\n    .duration(10)\n    .style(\"opacity\",function(d){console.log(d.text + \" \" + d.life);return d.life/maxLife})\n    .transition()\n    .duration(function(d){console.log(\"clicked\");return d.life;})\n    .style(\"opacity\",1)\n    .each('end',function(d){\n      removeNode(d);\n    });\n  };\n\n  this.addNode = function(doc){\n    nodes.push(doc);\n    update();\n  };\n\n  this.removeNode = function (doc) {\n    var i = 0;\n    var n = findNode(doc._id);\n    nodes.splice(findNodeIndex(doc),1);\n    update();\n  };\n\n  var removeNode = function (doc) {\n    var i = 0;\n    var n = findNode(doc._id);\n    nodes.splice(findNodeIndex(doc),1);\n    update();\n  };\n  \n  var findNode = function(id) {\n    for (var i in nodes) {\n      if (nodes[i]._id === id) return nodes[i];};\n  };\n\n  var findNodeIndex = function(doc) {\n    for (var i=0;i<nodes.length;i++) {\n      if (nodes[i].id==doc._id){\n        return i;\n      }\n    };\n  };\n\n  var w = 500,\n      h = 500;\n  var svg = d3.select(el)\n    .append(\"svg:svg\")\n    .attr(\"width\", w)\n    .attr(\"height\", h)\n    .attr(\"id\",\"svg\")\n    .attr(\"pointer-events\", \"all\")\n    .attr(\"viewBox\",\"0 0 \"+w+\" \"+h)\n    .attr(\"perserveAspectRatio\",\"xMinYMid\");\n\n  var vis = svg.append('svg:g');\n\n  var force = d3.layout.force();\n\n  var nodes = force.nodes();\n  \n  var label = d3.select(\"#bubble-labels\");\n\n\n  var update = function(){\n\n  var node = vis.selectAll(\"g.node\")\n    .data(nodes, function(d) { return d._id; });\n\n  var nodeEnter = node.enter().append(\"g\")\n    .attr(\"class\",\"node\")\n    .call(force.drag);\n\n  nodeEnter.append(\"svg:circle\")\n    .attr(\"r\",function(d){return d.radius;})\n    .attr(\"id\", function(d){return \"Node;\" + d.id})\n    .attr(\"class\",\"nodeStrokeClass\")\n    .style(\"fill\", function(d, i) { return \"red\"; })\n    .style(\"opacity\",1)\n    .attr(\"id\", function(d){\n        console.log(d.text + \" \" + d._id + \" add id\");\n        return \"circle-\"+d._id;\n    });\n\n//the native solution\n  nodeEnter.append(\"svg:text\")\n    .attr(\"class\",\"textClass\")      \n    .style(\"fill\",function(d,i){return color(i%3);})\n    .text(function(d){return d.text})\n    .style(\"opacity\",function(d){console.log(d.text + \" \" + d.life);return d.life/maxLife})\n    .transition()\n    .duration(function(d){return d.life})\n    .style(\"opacity\",0)\n    .each('end',function(d){\n      removeNode(d);\n    })\n    .attr(\"data-id\", function(d){\n        return d._id;\n    })\n    .attr(\"id\", function(d){\n        console.log(d.text + \" \" + d._id + \" add id\");\n        return \"node-\"+d._id;\n    });\n\n  // for(var i = 0; i<nodes.length; i++){\n  //   console.log(nodes[i]._id + \" nodes\");\n  //   d3plus.textwrap()\n  //     .container(d3.select(\"#circle-\"+nodes[i]._id))\n  //     .resize(true)\n  //     .draw();\n  // }\n\n// the foreign solution\n  nodeEnter.append(\"foreignObject\")\n    .attr(\"width\", 480)\n    .attr(\"height\", 500)\n    .attr(\"x\",function(d){return d.x;})\n    .append(\"xhtml:body\")\n    .style(\"font\", \"14px 'Helvetica Neue'\")\n    .html(\"<p> a <p>\");\n\n//foreign object solution\n  // nodeEnter.append(\"foreignObject\")\n  //   .attr(\"class\",\"textClass2\")\n  //   .attr('x', -150/2)\n  //   .attr('y', -20)\n  //   .attr(\"width\", 150)\n  //   .attr(\"height\", 200)\n  //   .append(\"xhtml:p\")\n  //   .attr('style','word-wrap: break-word; text-align:center;')\n  //   .style(\"color\",function(d,i){return color(i%3);})\n  //   .html(function(d){return d.text})\n  //   .transition()\n  //   .duration(500)\n  //   .style(\"opacity\",0);\n    \n\n  node.exit().remove();\n\n\n  force.on(\"tick\", function() {\n    var q = d3.geom.quadtree(nodes),\n        i = 0,\n        n = nodes.length;\n\n    while (++i < n) q.visit(collide(nodes[i]));\n    node.attr(\"transform\", function(d) { return \"translate(\" + d.x + \",\" + d.y + \")\"; });\n\n    d3.select(\"#bubble-labels\").selectAll(\".bubble-label\")\n      .style(\"left\", function(d){return ( d.x  - d.radius/2 + \"px\" );})\n      .style(\"top\", function(d){return (  d.y + 120 - d.radius/2 + \"px\" ); });\n  });\n\n    function collide(node) {\n      // console.log(\"collide\");\n      var r = node.radius + 16,\n          nx1 = node.x - r,\n          nx2 = node.x + r,\n          ny1 = node.y - r,\n          ny2 = node.y + r;\n      return function(quad, x1, y1, x2, y2) {\n        if (quad.point && (quad.point !== node)) {\n          var x = node.x - quad.point.x,\n              y = node.y - quad.point.y,\n              l = Math.sqrt(x * x + y * y),\n              r = node.radius + quad.point.radius;\n          if (l < r ) {\n            l = (l - r) / l * .5;\n            node.x -= x *= l;\n            node.y -= y *= l;\n            quad.point.x += x;\n            quad.point.y += y;\n          }\n        }\n        return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;\n      };\n    }\n\n\n      force\n        .gravity(.05)\n        .size([w, h])\n        .start();\n  };\n\n  update();\n\n}\n\n});\n"]},"hash":"8aeeb72597b87de4a743a093ffb21703024e1107"}
